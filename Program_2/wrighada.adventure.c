/******************************************************************************
**  Author:      Adam Wright
**  Email:       wrighada@oregonstate.edu
**  Date:        4/18/2020
**  Description: Program 2 for spring 2020 OSU cs-344. This program opens up
**               the room files generated by wrighada.buildrooms and then
**               uses them to form the layout of a maze which this program
**               allows the user to navigate.
******************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <time.h>
#include <dirent.h>
#include <pthread.h>


/* Global Constants */
#define ROOM_COUNT  7
#define CONNECT_MAX 6

/* Definition for the bool type */
typedef enum
{
    false,
    true
} bool;

/* Definition for Room struct */
struct Room
{
    char* name;
    char* type;
    int connect_count;
    struct Room* out_connect[CONNECT_MAX];
};

/* Array holding the 3 types of the rooms */
char* room_types[3] = 
{
    "START_ROOM",
    "END_ROOM",
    "MID_ROOM"
};

/* Array to hold the created rooms */
struct Room* Room_Arr[ROOM_COUNT];

/* Array to hold the name of the newest directory that contains my prefix */
char newestDirName[256];

/* File to hold the currently requested time */
char* time_file = "currentTime.txt";

/* Lock for switching threads to display the time */
pthread_mutex_t time_lock = PTHREAD_MUTEX_INITIALIZER;

/* In game variables */
int i, j;
int step_count = 0;



/* FUNCTION DECLARATIONS ----------------------------------------------------*/

void Get_Newest_Dir();
void Init_Room_Arr();
void Fill_Room_Arr();
void Game_Prompt();


/* MAIN ---------------------------------------------------------------------*/

int main()
{
    /* Search the current directory for the newest subdirectory */
    Get_Newest_Dir();
    printf("Newest entry found is: %s\n", newestDirName);

    /* Create and fill an array of struct rooms with the newest room data */
    Init_Room_Arr();
    Fill_Room_Arr();

    /* Run the game loop */
    do
    {
        break;
    } while (true);





    /* Free the array of room structs */
    i = 0;
    while (i < ROOM_COUNT)
    {
        free(Room_Arr[i]);
        i++;
    }

    return 0;
}


/* FUNCTION DEFINITIONS -----------------------------------------------------*/

/* Function that finds the most recent room directory */
void Get_Newest_Dir()
{
  int newestDirTime = -1; /* Modified timestamp of newest subdir examined */
  char targetDirPrefix[32] = "wrighada.rooms."; /* Prefix we're looking for */
  memset(newestDirName, '\0', sizeof(newestDirName)); /* newest directory that contains my prefix */

  DIR* dirToCheck; /*Holds the directory we're starting in */
  struct dirent* fileInDir; /* Holds the current subdir of the starting dir */
  struct stat dirAttributes; /* Holds information we've gained about subdir */

  dirToCheck = opendir("."); /* Open up the directory this program was run in */

    if (dirToCheck > 0) /* Make sure the current directory could be opened */
    {
        while ((fileInDir = readdir(dirToCheck)) != NULL) /* Check each entry in dir */
        {
            if (strstr(fileInDir->d_name, targetDirPrefix) != NULL) /* If entry has prefix */
            {
                stat(fileInDir->d_name, &dirAttributes); /*Get attributes of the entry */

                if ((int)dirAttributes.st_mtime > newestDirTime) /* If this time is bigger */
                {
                    newestDirTime = (int)dirAttributes.st_mtime;
                    memset(newestDirName, '\0', sizeof(newestDirName));
                    strcpy(newestDirName, fileInDir->d_name);
                }
            }
        }
    }

  closedir(dirToCheck); /* Close the directory we opened */
}


/* Initialize memory for the room struct array */
void Init_Room_Arr()
{
    /* Create space on the heap for the struct rooms array */
    for (i = 0; i < ROOM_COUNT; i++)
    {
        Room_Arr[i] = malloc(sizeof(struct Room));

        /* Set all of the connection array values to 0 */
        for (j = 0; j < CONNECT_MAX; j++)
        {
            Room_Arr[i]->out_connect[j] = NULL;
        }
    }
}

/* Fills the room array with data from most recent directory */
void Fill_Room_Arr()
{
    int file_num = 0;
    DIR* Newest_Dir = opendir(newestDirName);
    struct dirent* file_in_dir;

    while (file_in_dir = readdir(Newest_Dir))
    {
        if (file_in_dir->d_name[0] != '.')
        {
            Room_Arr[file_num]->name = file_in_dir->d_name;
            file_num++;
        }
    }

    for (i = 0; i <  7; i++)
    {
        printf("Roomname %d: %s\n", i, Room_Arr[i]->name);
    }



    closedir(Newest_Dir);
}


/* Print the game menu */
void Game_Prompt()
{
    printf("CURRENT LOCATION: \n");
    printf("POSSIBLE CONNECTIONS: \n");
    printf("WHERE TO? >");
}



